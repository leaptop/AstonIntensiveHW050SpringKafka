version: '3'
# Раздел со списком сервисов (контейнеров), которые docker compose будет поднимать
services:
  postgres: # Имя сервиса (логическое). По нему можно делать: docker compose logs postgres
    image: postgres:16 # Какой Docker-образ запустить: официальный Postgres версии 16
    container_name: user-service-postgres # Явное имя контейнера (вместо автосгенерированного)
    environment: # Переменные окружения, которые читает entrypoint образа Postgres при первом запуске
      POSTGRES_DB: user_service_db # Создать БД с таким именем (только при первой инициализации, когда volume пустой)
      POSTGRES_USER: user_service_user # Создать пользователя с таким именем (при первой инициализации)
      POSTGRES_PASSWORD: StrongPassword_123 # Пароль для этого пользователя (при первой инициализации)
    ports: # Проброс портов из контейнера на хост-машину (твой Windows)
      - "5432:5432" # host:container → на ПК порт 5432 будет направляться в контейнер на порт 5432
    volumes: # Монтирование томов (постоянного хранилища) внутрь контейнера
      - pgdata:/var/lib/postgresql/data # Именованный volume "pgdata" подключить как папку data Postgres внутри контейнера

  # Сервис Zookeeper — координатор для Kafka (хранит метаданные, управляет кластером)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0 # Официальный образ Zookeeper от Confluent
    container_name: zookeeper # Фиксированное имя контейнера для удобства
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181 # Порт, на котором Zookeeper слушает клиентов (в частности, Kafka)
      ZOOKEEPER_TICK_TIME: 2000 # Базовый интервал времени в миллисекундах для поддержания сессий и синхронизации
    ports:
      - "2181:2181" # Проброс порта наружу, если нужно подключаться к Zookeeper с хоста (например, для администрирования)

  # Сервис Kafka — брокер сообщений (потоковая платформа)
  kafka:
    image: confluentinc/cp-kafka:7.6.0 # Официальный образ Kafka от Confluent
    container_name: kafka # Явное имя контейнера
    depends_on:
      - zookeeper # Указывает, что сначала должен быть запущен Zookeeper (контейнер kafka начнёт ждать его готовности)
    ports:
      - "9092:9092" # Проброс порта для доступа к Kafka с хост-машины
    environment:
      KAFKA_BROKER_ID: 1 # Уникальный идентификатор брокера в кластере
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 # Адрес Zookeeper внутри сети Docker (имя сервиса + порт)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092 # Как брокер сообщает свой адрес клиентам (важно для подключения с хоста)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 # Фактор репликации для внутреннего топика __consumer_offsets. Для одного брокера должно быть 1.
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0 # Задержка перед первой балансировкой групп потребителей (0 — сразу)

# Раздел с объявлением именованных volumes (томов), которыми пользуются сервисы
volumes:
  pgdata: # Определяем volume с именем pgdata (реально Docker может создать user-service_pgdata с префиксом проекта)
  # Если понадобятся тома для Kafka или Zookeeper (например, для сохранения данных), их можно добавить аналогично.

# POSTGRES_DB/USER/PASSWORD срабатывают только при первом запуске, когда volume pgdata ещё пустой.
# Если ты меняешь пароль в compose, но volume уже с данными — пароль не “обновится сам”.
#
# Volume pgdata — это причина, почему база не пропадает при docker compose down.
# Чтобы удалить и контейнер, и данные базы:
# docker compose down -v